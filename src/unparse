#!/usr/bin/env node

var path = require('path');
var cwd = process.cwd();

// Allows the server to be launched from another directory
process.chdir(__dirname);

var configCtrl = require('./config/index.js');

// Get argv
var argv = process.argv;
if (argv[0] == 'node') {
	argv = argv.slice(2);
} else {
	argv = argv.slice(1);
}

// Parse argv
var opt = require('node-getopt').create([
	['h' , 'help', 'display this help'],
	['c', 'config-file=ARG', 'set Unparse config file']
])
.setHelp('Usage: node unparse [OPTIONS]\n'+
	'An open-source clone of Parse.\n\n'+
	'Arguments:\n'+
	'  server  start the server\n'+
	'  init  populate the database with default classes\n\n'+
	'Options:\n[[OPTIONS]]\n')
.bindHelp()
.parseSystem();

if (opt.options['config-file']) {
	var filepath = path.resolve(cwd, opt.options['config-file']);
	configCtrl.setPath(filepath);
}

switch (opt.argv[0]) {
	case 'init':
		// Initialize unparse
		var crypto = require('crypto');
		var db = require('./lib/db');

		/**
		 * Generate a key.
		 * @return {String} The generated key.
		 */
		function generateKey() {
			var sha = crypto.createHash('sha1');
			sha.update(Math.random().toString());
			return sha.digest('hex');
		}

		// Generate app ID and keys if empty
		var config = null;
		return configCtrl.read().then(function (cfg) {
			config = cfg;

			if (!config.appId) {
				config.appId = generateKey();
				console.log('App ID generated: '+config.appId);
			}

			var keysNames = ['javascriptKey', 'restKey'];
			for (var i = 0; i < keysNames.length; i++) {
				var keyName = keysNames[i],
					keyValue = config[keyName];

				if (!keyValue) {
					keyValue = generateKey();
					config[keyName] = keyValue;

					console.log(keyName+' generated: '+keyValue);
				}
			}

			return configCtrl.write(config);
		}).then(function () {
			// Populate the database with default classes
			console.log('Connecting to the database...');
			return db.connect(config).then(function () {
				console.log('Populating database with default classes...');
				return db.init();
			}).then(function () {
				console.log('Database populated with default classes.');
			}, function (err) {
				console.error('Failed to populate the database.');
				throw err;
			});
		}).then(function () {
			process.exit(0);
		}, function (err) {
			console.error(err.stack || err);
			process.exit(1);
		});
		return;
	case 'server':
	default:
		// Start the server
		var appBuilder = require('./app');
		var app = appBuilder(configCtrl.readSync());

		var server = app.listen(process.env.PORT || 3000, function() {
			console.log('Server listening on port ' + server.address().port);
		});
		return server;
}